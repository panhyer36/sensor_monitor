{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">{% trans "User Profile" %}</h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3 text-center">
                        <div class="profile-img-container mb-3">
                            <div class="profile-avatar">
                                <i class="bi bi-person-circle"></i>
                            </div>
                        </div>
                        <h5>{{ user.username }}</h5>
                        <p class="text-muted">{% trans "Member since " %} {{ user.date_joined|date:"F j, Y" }}</p>
                        
                        <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <a class="nav-link {% if active_tab == 'profile' %}active{% endif %}" id="profile-tab" data-bs-toggle="pill" href="#profile-content" role="tab" aria-controls="profile-content" aria-selected="true">
                                <i class="bi bi-person-badge me-2"></i> {% trans "Profile Information" %}
                            </a>
                            <a class="nav-link {% if active_tab == 'username' %}active{% endif %}" id="username-tab" data-bs-toggle="pill" href="#username-content" role="tab" aria-controls="username-content" aria-selected="false">
                                <i class="bi bi-person me-2"></i> {% trans "Change Username" %}
                            </a>
                            <a class="nav-link {% if active_tab == 'password' %}active{% endif %}" id="password-tab" data-bs-toggle="pill" href="#password-content" role="tab" aria-controls="password-content" aria-selected="false">
                                <i class="bi bi-shield-lock me-2"></i> {% trans "Change Password" %}
                            </a>
                            <a class="nav-link {% if active_tab == 'notifications' %}active{% endif %}" id="notifications-tab" data-bs-toggle="pill" href="#notifications-content" role="tab" aria-controls="notifications-content" aria-selected="false">
                                <i class="bi bi-bell me-2"></i> {% trans "Notification Settings" %}
                            </a>
                            <a class="nav-link {% if active_tab == 'thresholds' %}active{% endif %}" id="thresholds-tab" data-bs-toggle="pill" href="#thresholds-content" role="tab" aria-controls="thresholds-content" aria-selected="false">
                                <i class="bi bi-sliders me-2"></i> {% trans "Threshold Settings" %}
                            </a>
                            <a class="nav-link" id="account-tab" data-bs-toggle="pill" href="#account-content" role="tab" aria-controls="account-content" aria-selected="false">
                                <i class="bi bi-info-circle me-2"></i> {% trans "Account Information" %}
                            </a>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="tab-content" id="v-pills-tabContent">
                            <!-- Profile Information Tab -->
                            <div class="tab-pane fade {% if active_tab == 'profile' %}show active{% endif %}" id="profile-content" role="tabpanel" aria-labelledby="profile-tab">
                                <h5 class="border-bottom pb-2 mb-4">{% trans "Update Profile Information" %}</h5>
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="id_first_name" class="form-label">{% trans "First Name" %}</label>
                                        <input type="text" name="first_name" value="{{ profile_form.first_name.value|default:'' }}" class="form-control {% if profile_form.first_name.errors %}is-invalid{% endif %}" id="id_first_name">
                                        {% if profile_form.first_name.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in profile_form.first_name.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_last_name" class="form-label">{% trans "Last Name" %}</label>
                                        <input type="text" name="last_name" value="{{ profile_form.last_name.value|default:'' }}" class="form-control {% if profile_form.last_name.errors %}is-invalid{% endif %}" id="id_last_name">
                                        {% if profile_form.last_name.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in profile_form.last_name.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_email" class="form-label">{% trans "Email" %}</label>
                                        <input type="email" name="email" value="{{ profile_form.email.value|default:'' }}" class="form-control {% if profile_form.email.errors %}is-invalid{% endif %}" id="id_email">
                                        {% if profile_form.email.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in profile_form.email.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <button type="submit" name="profile_submit" class="btn btn-primary">{% trans "Update Profile" %}</button>
                                </form>

                                <hr class="my-4">

                                <h5 class="border-bottom pb-2 mb-4">{% trans "API Key Configuration" %}</h5>
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="id_api_key" class="form-label">
                                            {{ api_key_form.api_key.label }}
                                            <a href="https://platform.deepseek.com/api_keys" target="_blank" class="btn btn-sm btn-outline-info ms-2" title="{% trans 'Get DeepSeek API Key' %}">
                                                <i class="bi bi-box-arrow-up-right"></i> {% trans "Get Key" %}
                                            </a>
                                        </label>
                                        <div class="input-group">
                                            <input type="password" name="api_key" value="{{ api_key_form.api_key.value|default:'' }}" class="form-control {% if api_key_form.api_key.errors %}is-invalid{% endif %}" id="id_api_key" placeholder="{{ api_key_form.api_key.field.widget.attrs.placeholder }}">
                                            <button class="btn btn-outline-secondary" type="button" id="checkApiKeyBtn">{% trans "Check Connection" %}</button>
                                        </div>
                                        <div id="apiKeyStatus" class="mt-1" style="min-height: 1.2em;"></div>
                                        {% if api_key_form.api_key.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in api_key_form.api_key.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            {{ api_key_form.api_key.help_text }}
                                        </small>
                                    </div>
                                    <button type="submit" name="api_key_submit" class="btn btn-secondary">{% trans "Save API Key" %}</button>
                                </form>

                            </div>
                            
                            <!-- Change Username Tab -->
                            <div class="tab-pane fade {% if active_tab == 'username' %}show active{% endif %}" id="username-content" role="tabpanel" aria-labelledby="username-tab">
                                <h5 class="border-bottom pb-2 mb-4">{% trans "Change Your Username" %}</h5>
                                <div class="alert alert-info" role="alert">
                                    <i class="bi bi-info-circle-fill me-2"></i>
                                    <strong>{% trans "Note:" %}</strong> {% trans "Changing your username may affect how you log in and how others identify you in the system." %}
                                </div>
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="id_current_username" class="form-label" style="color: black;">{% trans "Current Username" %}</label>
                                        <input type="text" value="{{ user.username }}" class="form-control" id="id_current_username" disabled style="color: black;">
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_username" class="form-label">{% trans "New Username" %}</label>
                                        <input type="text" name="username" value="{{ username_form.username.value|default:'' }}" class="form-control {% if username_form.username.errors %}is-invalid{% endif %}" id="id_username" required>
                                        {% if username_form.username.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in username_form.username.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            {% trans "Usernames can only contain letters, numbers, and the characters @, ., +, -, and _" %}
                                        </small>
                                    </div>
                                    
                                    {% if username_form.non_field_errors %}
                                        <div class="alert alert-danger">
                                            {% for error in username_form.non_field_errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    <button type="submit" name="username_submit" class="btn btn-primary">{% trans "Change Username" %}</button>
                                </form>
                            </div>
                            
                            <!-- Change Password Tab -->
                            <div class="tab-pane fade {% if active_tab == 'password' %}show active{% endif %}" id="password-content" role="tabpanel" aria-labelledby="password-tab">
                                <h5 class="border-bottom pb-2 mb-4">{% trans "Change Your Password" %}</h5>
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="id_old_password" class="form-label">{% trans "Current Password" %}</label>
                                        <input type="password" name="old_password" class="form-control {% if password_form.old_password.errors %}is-invalid{% endif %}" id="id_old_password" required>
                                        {% if password_form.old_password.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in password_form.old_password.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_new_password1" class="form-label">{% trans "New Password" %}</label>
                                        <input type="password" name="new_password1" class="form-control {% if password_form.new_password1.errors %}is-invalid{% endif %}" id="id_new_password1" required>
                                        {% if password_form.new_password1.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in password_form.new_password1.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <small class="form-text text-muted">
                                            {% trans "Password must contain at least 8 characters and cannot be entirely numeric." %}
                                        </small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="id_new_password2" class="form-label">{% trans "Confirm New Password" %}</label>
                                        <input type="password" name="new_password2" class="form-control {% if password_form.new_password2.errors %}is-invalid{% endif %}" id="id_new_password2" required>
                                        {% if password_form.new_password2.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in password_form.new_password2.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    {% if password_form.non_field_errors %}
                                        <div class="alert alert-danger">
                                            {% for error in password_form.non_field_errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    <button type="submit" name="password_submit" class="btn btn-primary">{% trans "Change Password" %}</button>
                                </form>
                            </div>
                            
                            <!-- Notification Settings Tab -->
                            <div class="tab-pane fade {% if active_tab == 'notifications' %}show active{% endif %}" id="notifications-content" role="tabpanel" aria-labelledby="notifications-tab">
                                <h5 class="border-bottom pb-2 mb-4">{% trans "Notification Settings" %}</h5>
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="mb-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch" id="id_email_notifications" name="email_notifications" {% if notification_form.email_notifications.value %}checked{% endif %}>
                                            <label class="form-check-label" for="id_email_notifications">{% trans "Receive Email Notifications" %}</label>
                                        </div>
                                        <div class="form-text text-muted">
                                            {{ notification_form.email_notifications.help_text }}
                                        </div>
                                    </div>
                                    
                                    {% if not user.email %}
                                    <div class="alert alert-warning mb-4">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                        {% blocktrans %}You haven't set an email address yet. Please add an email address in your <a href="#profile-content" data-bs-toggle="pill" aria-controls="profile-content" aria-selected="true">Profile Information</a> to receive notifications.{% endblocktrans %}
                                    </div>
                                    {% endif %}
                                    
                                    <button type="submit" name="notification_submit" class="btn btn-primary">{% trans "Save Settings" %}</button>
                                </form>
                                
                                <hr class="my-4">
                                
                                <h5 class="mb-3">{% trans "Test Email Notification" %}</h5>
                                <p class="text-muted mb-4">{% trans "Send a test email to your inbox to verify that notification settings are working properly." %}</p>
                                
                                <button id="testEmailBtn" class="btn btn-outline-primary" {% if not user.email %}disabled{% endif %}>
                                    <i class="bi bi-envelope me-2"></i>{% trans "Send Test Email" %}
                                </button>
                                
                                <div id="testEmailResult" class="mt-3" style="display: none;">
                                    <div class="alert" role="alert"></div>
                                </div>
                            </div>
                            
                            <!-- Threshold Settings Tab -->
                            <div class="tab-pane fade {% if active_tab == 'thresholds' %}show active{% endif %}" id="thresholds-content" role="tabpanel" aria-labelledby="thresholds-tab">
                                <h5 class="border-bottom pb-2 mb-4">{% trans "Sensor Threshold Settings" %}</h5>
                                <p class="text-muted mb-4">
                                    {% trans "Set notification thresholds for each sensor. You will be notified when data exceeds your set ranges." %}
                                </p>
                                
                                <form method="post">
                                    {% csrf_token %}
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card mb-4">
                                                <div class="card-header bg-primary text-white">
                                                    <i class="bi bi-thermometer-half me-2"></i> {% trans "Temperature Settings" %}
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3 d-flex justify-content-end">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" role="switch" id="tempUnitToggle">
                                                            <label class="form-check-label" for="tempUnitToggle">
                                                                °C / °F
                                                            </label>
                                                        </div>
                                                        <input type="hidden" name="temp_unit" id="tempUnitInput" value="C">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="id_temp_min" class="form-label">{% trans "Minimum Temperature" %} (<span class="temp-unit">°C</span>)</label>
                                                        {{ threshold_form.temp_min }}
                                                        <div class="form-text">{% trans "Notification will trigger below this temperature" %}</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="id_temp_max" class="form-label">{% trans "Maximum Temperature" %} (<span class="temp-unit">°C</span>)</label>
                                                        {{ threshold_form.temp_max }}
                                                        <div class="form-text">{% trans "Notification will trigger above this temperature" %}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="card mb-4">
                                                <div class="card-header bg-primary text-white">
                                                    <i class="bi bi-droplet-half me-2"></i> {% trans "Humidity Settings" %}
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3">
                                                        <label for="id_humidity_min" class="form-label">{% trans "Minimum Humidity" %} (%)</label>
                                                        {{ threshold_form.humidity_min }}
                                                        <div class="form-text">{% trans "Notification will trigger below this humidity" %}</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="id_humidity_max" class="form-label">{% trans "Maximum Humidity" %} (%)</label>
                                                        {{ threshold_form.humidity_max }}
                                                        <div class="form-text">{% trans "Notification will trigger above this humidity" %}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card mb-4">
                                                <div class="card-header bg-primary text-white">
                                                    <i class="bi bi-cloud me-2"></i> {% trans "Air Quality Settings" %}
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3">
                                                        <label for="id_co2_max" class="form-label">{% trans "Maximum CO2 Level" %} (ppm)</label>
                                                        {{ threshold_form.co2_max }}
                                                        <div class="form-text">{% trans "Notification will trigger above this concentration" %}</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="id_aqi_max" class="form-label">{% trans "Maximum AQI" %}</label>
                                                        {{ threshold_form.aqi_max }}
                                                        <div class="form-text">{% trans "Notification will trigger above this AQI value" %}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="card mb-4">
                                                <div class="card-header bg-primary text-white">
                                                    <i class="bi bi-exclamation-triangle me-2"></i> {% trans "Particulate Matter Settings" %}
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3">
                                                        <label for="id_pm25_max" class="form-label">{% trans "Maximum PM2.5 Level" %} (μg/m³)</label>
                                                        {{ threshold_form.pm25_max }}
                                                        <div class="form-text">{% trans "Notification will trigger above this concentration" %}</div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="id_pm10_max" class="form-label">{% trans "Maximum PM10 Level" %} (μg/m³)</label>
                                                        {{ threshold_form.pm10_max }}
                                                        <div class="form-text">{% trans "Notification will trigger above this concentration" %}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mb-4">
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                        {% trans "These thresholds are for your personal notification settings only and won't affect dashboard displays or other users." %}
                                    </div>
                                    
                                    <button type="submit" name="threshold_submit" class="btn btn-primary">{% trans "Save Threshold Settings" %}</button>
                                </form>
                            </div>
                            
                            <!-- Account Details Tab -->
                            <div class="tab-pane fade" id="account-content" role="tabpanel" aria-labelledby="account-tab">
                                <h5 class="border-bottom pb-2 mb-4">{% trans "Account Information" %}</h5>
                                <div class="table-responsive">
                                    <table class="table">
                                        <tbody>
                                            <tr>
                                                <th scope="row" style="width: 30%;">{% trans "Username" %}</th>
                                                <td>{{ user.username }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row">{% trans "Email" %}</th>
                                                <td>{{ user.email|default:_("Not provided") }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row">{% trans "Full Name" %}</th>
                                                <td>
                                                    {% if user.first_name or user.last_name %}
                                                        {{ user.first_name }} {{ user.last_name }}
                                                    {% else %}
                                                        {% trans "Not provided" %}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th scope="row">{% trans "Last Login" %}</th>
                                                <td>{{ user.last_login|date:"F j, Y, g:i a" }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row">{% trans "Date Joined" %}</th>
                                                <td>{{ user.date_joined|date:"F j, Y, g:i a" }}</td>
                                            </tr>
                                            <tr>
                                                <th scope="row">{% trans "Staff Status" %}</th>
                                                <td>{% if user.is_staff %}{% trans "Yes" %}{% else %}{% trans "No" %}{% endif %}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    .profile-img-container {
        display: flex;
        justify-content: center;
    }
    
    .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #dee2e6;
    }
    
    .profile-avatar i {
        font-size: 80px;
        color: #6c757d;
    }
    
    .invalid-feedback {
        display: block;
    }
    
    .nav-pills .nav-link {
        text-align: left;
        margin-bottom: 5px;
        border-radius: 5px;
        transition: all 0.3s;
    }
    
    .nav-pills .nav-link.active {
        background-color: #0d6efd;
        box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3);
    }
    
    .nav-pills .nav-link:not(.active):hover {
        background-color: #f8f9fa;
        color: #5cbbaf;
    }
    
    .tab-content {
        min-height: 300px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Test email sending functionality
    const testEmailBtn = document.getElementById('testEmailBtn');
    const testEmailResult = document.getElementById('testEmailResult');
    const resultAlert = testEmailResult.querySelector('.alert');
    const sendTestEmailText = "{% trans 'Send Test Email' %}";
    const sendingText = "{% trans 'Sending...' %}";
    const requestErrorText = "{% trans 'Request error: ' %}";

    if (testEmailBtn) {
        testEmailBtn.addEventListener('click', function() {
            // Disable button and show loading state
            testEmailBtn.disabled = true;
            testEmailBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${sendingText}`;
            
            // Hide previous results
            testEmailResult.style.display = 'none';
            
            // Send request
            fetch('{% url "send_test_email" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                // Show result
                if (data.success) {
                    resultAlert.className = 'alert alert-success';
                } else {
                    resultAlert.className = 'alert alert-danger';
                }
                resultAlert.textContent = data.message;
                testEmailResult.style.display = 'block';
                
                // Restore button state
                testEmailBtn.disabled = false;
                testEmailBtn.innerHTML = `<i class="bi bi-envelope me-2"></i>${sendTestEmailText}`;
            })
            .catch(error => {
                // Show error
                resultAlert.className = 'alert alert-danger';
                resultAlert.textContent = requestErrorText + error.message;
                testEmailResult.style.display = 'block';
                
                // Restore button state
                testEmailBtn.disabled = false;
                testEmailBtn.innerHTML = `<i class="bi bi-envelope me-2"></i>${sendTestEmailText}`;
            });
        });
    }

    // Temperature unit toggle functionality
    const tempUnitToggle = document.getElementById('tempUnitToggle');
    const tempUnitInput = document.getElementById('tempUnitInput');
    const tempUnitSpans = document.querySelectorAll('.temp-unit');
    const tempMinInput = document.getElementById('id_temp_min');
    const tempMaxInput = document.getElementById('id_temp_max');
    
    if (tempUnitToggle) {
        // Function to convert Celsius to Fahrenheit
        function celsiusToFahrenheit(celsius) {
            return (celsius * 9/5) + 32;
        }
        
        // Function to convert Fahrenheit to Celsius
        function fahrenheitToCelsius(fahrenheit) {
            return (fahrenheit - 32) * 5/9;
        }
        
        // Function to update temperature unit display
        function updateTempUnitDisplay(isFahrenheit) {
            tempUnitSpans.forEach(span => {
                span.textContent = isFahrenheit ? '°F' : '°C';
            });
            tempUnitInput.value = isFahrenheit ? 'F' : 'C';
        }
        
        // Function to convert input values between units
        function convertTemperatureValues(toCelsius) {
            if (tempMinInput.value) {
                tempMinInput.value = toCelsius 
                    ? fahrenheitToCelsius(parseFloat(tempMinInput.value)).toFixed(1)
                    : celsiusToFahrenheit(parseFloat(tempMinInput.value)).toFixed(1);
            }
            
            if (tempMaxInput.value) {
                tempMaxInput.value = toCelsius
                    ? fahrenheitToCelsius(parseFloat(tempMaxInput.value)).toFixed(1)
                    : celsiusToFahrenheit(parseFloat(tempMaxInput.value)).toFixed(1);
            }
        }
        
        // Handle toggle change
        tempUnitToggle.addEventListener('change', function() {
            const isFahrenheit = this.checked;
            updateTempUnitDisplay(isFahrenheit);
            convertTemperatureValues(!isFahrenheit); // Convert FROM the current unit TO the new unit
        });
        
        // Initialize with Celsius
        updateTempUnitDisplay(false);
        
        // Handle form submission - convert back to Celsius if needed
        const thresholdForm = tempUnitToggle.closest('form');
        if (thresholdForm) {
            thresholdForm.addEventListener('submit', function(e) {
                // If currently in Fahrenheit, convert back to Celsius before submitting
                if (tempUnitToggle.checked) {
                    convertTemperatureValues(true);
                }
            });
        }
    }

    // API Key Check functionality
    const checkApiKeyBtn = document.getElementById('checkApiKeyBtn');
    const apiKeyInput = document.getElementById('id_api_key');
    const apiKeyStatus = document.getElementById('apiKeyStatus');
    const checkConnectionText = "{% trans 'Check Connection' %}";
    const checkingText = "{% trans 'Checking...' %}";
    const checkingConnectionText = "{% trans 'Checking connection...' %}";
    const enterApiKeyText = "{% trans 'Please enter an API Key.' %}";
    const requestErrorGeneralText = "{% trans 'Request error. Please try again later.' %}";

    if (checkApiKeyBtn && apiKeyInput && apiKeyStatus) {
        checkApiKeyBtn.addEventListener('click', function() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                apiKeyStatus.innerHTML = `<span class="text-warning">${enterApiKeyText}</span>`;
                return;
            }

            // Show loading state
            checkApiKeyBtn.disabled = true;
            checkApiKeyBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${checkingText}`;
            apiKeyStatus.innerHTML = `<span class="text-muted">${checkingConnectionText}</span>`;

            // Send request to backend
            fetch('{% url "check_api_key" %}', { // Use Django url template tag
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                // Assuming data.message from backend is already translated or an identifier
                if (data.status === 'success') {
                    apiKeyStatus.innerHTML = `<span class="text-success"><i class="bi bi-check-circle-fill me-1"></i> ${data.message}</span>`;
                } else if (data.status === 'invalid') {
                    apiKeyStatus.innerHTML = `<span class="text-danger"><i class="bi bi-x-octagon-fill me-1"></i> ${data.message}</span>`;
                } else {
                    apiKeyStatus.innerHTML = `<span class="text-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i> ${data.message}</span>`;
                }
            })
            .catch(error => {
                apiKeyStatus.innerHTML = `<span class="text-danger">${requestErrorGeneralText}</span>`;
                console.error('Error checking API key:', error);
            })
            .finally(() => {
                // Restore button state
                checkApiKeyBtn.disabled = false;
                checkApiKeyBtn.innerHTML = checkConnectionText;
            });
        });
    }
});
</script>
{% endblock %} 